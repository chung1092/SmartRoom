{% extends "base.html" %}
{% block content %}
<div class="page-content">
    <div class="container-fluid">
        <!-- start page title -->
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                    <h4 class="mb-sm-0">Phân công phòng thi</h4>
                    <div class="page-title-right">
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item"><a href="javascript: void(0);">Quản lý</a></li>
                            <li class="breadcrumb-item active">Phân công phòng thi</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <!-- end page title -->

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">Tải lên danh sách sinh viên</h4>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" onsubmit="return false;">
                            <div class="dropzone" id="fileDropzone">
                                <input type="file" id="fileInput" multiple style="display: none;" accept=".xlsx,.xls">
                                <div class="dz-message needsclick">
                                    <div class="mb-3">
                                        <i class="display-4 text-muted ri-upload-cloud-2-fill"></i>
                                    </div>
                                    <h4>Thả file vào đây hoặc nhấp để tải lên.</h4>
                                    <p class="text-muted" style="font-size: 12px;">Hỗ trợ file Excel (.xlsx, .xls)</p>
                                </div>
                            </div>
                            <div id="fileList" class="mt-3"></div>
                            <div class="mt-3 text-center">
                                <button type="button" class="btn btn-primary" id="submitButton">
                                    <i class="ri-upload-line"></i> Tải lên
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Form with Tabs -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">Tải lên danh sách sinh viên</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tab1" role="tab">
                                    <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                                    <span class="d-none d-sm-block" style="font-weight: 800;">4 Ca</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tab2" role="tab">
                                    <span class="d-block d-sm-none"><i class="fas fa-user"></i></span>
                                    <span class="d-none d-sm-block" style="font-weight: 800;">6 Ca</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tab3" role="tab">
                                    <span class="d-block d-sm-none"><i class="fas fa-envelope"></i></span>
                                    <span class="d-none d-sm-block" style="font-weight: 800;">8 Ca</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tab4" role="tab">
                                    <span class="d-block d-sm-none"><i class="fas fa-cog"></i></span>
                                    <span class="d-none d-sm-block" style="font-weight: 800;">10 Ca</span>
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content p-3 text-muted">
                            <div class="tab-pane active" id="tab1" role="tabpanel">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 1</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 2</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 3</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 4</button>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab2" role="tabpanel">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 1</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 2</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 3</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 4</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 5</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 6</button>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab3" role="tabpanel">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 1</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 2</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 3</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 4</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 5</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 6</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 7</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 8</button>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab4" role="tabpanel">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 1</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 2</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 3</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 4</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 5</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 6</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 7</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 8</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 9</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">Ca thi 10</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">Phân công phòng thi</h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Hàng 1 -->
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-success toggle-btn toggle-all">Tầng 2</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">201</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">202</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">203</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">204</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">205</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">206</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">207</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">208</button>
                                </div>
                            </div>
                            <!-- Hàng 2 -->
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-success toggle-btn toggle-all">Tầng 3</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">301</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">302</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">303</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">304</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">305</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">306</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">307</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">308</button>
                                </div>
                            </div>
                            <!-- Hàng 3 -->
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-success toggle-btn toggle-all">Tầng 4</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">401</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">402</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">403</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">404</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">405</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">406</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">407</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">408</button>
                                </div>
                            </div>
                            <!-- Hàng 4 -->
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-success toggle-btn toggle-all">Tầng 5</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">501</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">502</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">503</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">504</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">505</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">506</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">507</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">508</button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2" style="justify-content: space-around;">
                                    <button type="button" class="btn btn-success toggle-btn toggle-all">Tầng 6</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">601</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">602</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">603</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">604</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">605</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">606</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">607</button>
                                    <button type="button" class="btn btn-outline-primary toggle-btn">608</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nút xác nhận -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary btn-lg" id="confirmBtn">Xác nhận</button>
            </div>
        </div>

        <!-- Form hiển thị kết quả -->
        <div class="row mt-4" id="resultForm" style="display: none;">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">Kết quả phân công phòng thi</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist" id="examTabs">
                            <!-- Tabs sẽ được thêm động bằng JavaScript -->
                        </ul>

                        <div class="tab-content p-3 text-muted" id="examTabContent">
                            <!-- Nội dung tab sẽ được thêm động bằng JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nút xác nhận phân công -->
        <div class="row mt-4" id="confirmAllocationBtn" style="display: none;">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-success btn-lg" id="saveAllocationBtn">Xác nhận phân công</button>
            </div>
        </div>
    </div>
</div>

<style>
    .dropzone {
        position: relative;
        min-height: 200px;
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .dropzone:hover,
    .dropzone.border-primary {
        border-color: #556ee6;
        background-color: rgba(85, 110, 230, 0.05);
    }

    .dz-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

    .file-item:hover {
        background-color: #e9ecef;
    }

    .file-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e3f2fd;
        border-radius: 0.5rem;
        margin-right: 10px;
    }

    .file-info {
        flex-grow: 1;
    }

    .file-name {
        font-weight: 500;
        margin-bottom: 2px;
    }

    .file-size {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .delete-btn {
        padding: 5px 10px;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background-color: #dc3545;
        color: white;
    }

    .nav-tabs-custom {
        border-bottom: 1px solid #dee2e6;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        color: #6c757d;
        padding: 1rem 1.5rem;
        font-weight: 500;
        position: relative;
    }

    .nav-tabs-custom .nav-link.active {
        color: #556ee6;
    }

    .nav-tabs-custom .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #556ee6;
    }

    .toggle-btn {
        transition: all 0.3s ease;
        min-width: 120px;
        position: relative;
        overflow: hidden;
    }

    .toggle-btn.active {
        background-color: #556ee6;
        color: white;
        border-color: #556ee6;
    }

    .toggle-btn:not(.active):hover {
        background-color: rgba(85, 110, 230, 0.1);
    }

    .toggle-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.3s ease, height 0.3s ease;
    }

    .toggle-btn:active::after {
        width: 200px;
        height: 200px;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .table-responsive {
        margin-top: 1rem;
    }

    .table th {
        background-color: #f8f9fa;
    }

    .nav-tabs .nav-link.active {
        font-weight: bold;
    }

    .tab-pane {
        padding: 1rem 0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dropzone = document.getElementById('fileDropzone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const submitButton = document.getElementById('submitButton');
        let files = [];

        // Xử lý click vào dropzone
        dropzone.addEventListener('click', function (e) {
            if (e.target === this || e.target.classList.contains('dz-message') || e.target.closest('.dz-message')) {
                fileInput.click();
            }
        });

        // Xử lý kéo thả file
        dropzone.addEventListener('dragover', function (e) {
            e.preventDefault();
            this.classList.add('border-primary');
        });

        dropzone.addEventListener('dragleave', function (e) {
            e.preventDefault();
            this.classList.remove('border-primary');
        });

        dropzone.addEventListener('drop', function (e) {
            e.preventDefault();
            this.classList.remove('border-primary');
            const droppedFiles = Array.from(e.dataTransfer.files);
            handleFiles(droppedFiles);
        });

        // Xử lý chọn file
        fileInput.addEventListener('change', function (e) {
            const selectedFiles = Array.from(e.target.files);
            handleFiles(selectedFiles);
        });

        // Xử lý file được chọn
        function handleFiles(newFiles) {
            newFiles.forEach(file => {
                if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    file.type === 'application/vnd.ms-excel') {
                    files.push(file);
                    displayFile(file);
                } else {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Chỉ hỗ trợ file Excel (.xlsx, .xls)',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }

        // Hiển thị file trong danh sách
        function displayFile(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
            <div class="file-icon">
                <i class="ri-file-excel-line text-primary"></i>
            </div>
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
            <button type="button" class="btn btn-link text-danger delete-btn" onclick="removeFile('${file.name}')">
                <i class="ri-delete-bin-line"></i>
            </button>
        `;
            fileList.appendChild(fileItem);
        }

        // Xóa file khỏi danh sách
        window.removeFile = function (fileName) {
            files = files.filter(file => file.name !== fileName);
            const fileItems = fileList.getElementsByClassName('file-item');
            for (let item of fileItems) {
                if (item.querySelector('.file-name').textContent === fileName) {
                    item.remove();
                    break;
                }
            }
        };

        // Hàm định dạng dung lượng file
        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Byte';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }

        // Add floor selection functionality
        const toggleAllButtons = document.querySelectorAll('.toggle-all');
        toggleAllButtons.forEach(button => {
            button.addEventListener('click', function() {
                const floorContainer = this.parentElement;
                const roomButtons = Array.from(floorContainer.querySelectorAll('.toggle-btn:not(.toggle-all)'));
                const isActive = this.classList.contains('active');
                
                // Toggle all room buttons in this floor
                roomButtons.forEach(roomBtn => {
                    roomBtn.classList.toggle('active', !isActive);
                });
                
                // Toggle the floor button
                this.classList.toggle('active');
                
                // Change floor button color
                if (!isActive) {
                    this.classList.remove('btn-success');
                    this.classList.add('btn-primary');
                } else {
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');
                }
            });
        });

        // Add individual room selection functionality
        const roomButtons = document.querySelectorAll('.toggle-btn:not(.toggle-all)');
        roomButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.classList.toggle('active');
                
                // Check if all rooms in the floor are selected
                const floorContainer = this.parentElement;
                const floorButton = floorContainer.querySelector('.toggle-all');
                const allRooms = Array.from(floorContainer.querySelectorAll('.toggle-btn:not(.toggle-all)'));
                const allActive = allRooms.every(room => room.classList.contains('active'));
                
                // Update floor button state
                if (allActive) {
                    floorButton.classList.add('active');
                    floorButton.classList.remove('btn-success');
                    floorButton.classList.add('btn-primary');
                } else {
                    floorButton.classList.remove('active');
                    floorButton.classList.remove('btn-primary');
                    floorButton.classList.add('btn-success');
                }
            });
        });
    });
</script>
{% endblock %}